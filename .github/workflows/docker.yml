name: Docker

on:
  workflow_dispatch:
    inputs:
      no_cache:
        description: 'ğŸ§¹ ê¸°ì¡´ ìºì‹œë¥¼ ë¬´ì‹œí•˜ê³  ìƒˆë¡œ ë¹Œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'
        required: false
        default: false
        type: boolean
  push:
    paths:
      - '**/Dockerfile'
      - '**/docker-compose.yml'
      - '**/docker-compose.override.yml'
    branches:
      - main
  pull_request:
    paths:
      - '**/Dockerfile'
      - '**/docker-compose.yml'
      - '**/docker-compose.override.yml'
    branches:
      - main

permissions:
  contents: read
  packages: write

env:
  EXTERNAL_IMAGES: ""

jobs:
  docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull & Cache External Images
        if: env.EXTERNAL_IMAGES != ''
        run: |
          for img in $EXTERNAL_IMAGES; do
            docker pull $img
          done

      - name: Build Local Dockerfiles
        run: |
          CACHE_OPTION=""
          if [ "${{ inputs.no_cache }}" == "true" ]; then
            CACHE_OPTION="--no-cache"
          fi
          
          find . -name "Dockerfile" -not -path "*/.*" | while read dockerfile; do
            dir=$(dirname "$dockerfile")
            module_name=$(basename "$dir")

            image_tag="${{ github.repository }}/$module_name:latest"
            image_tag=$(echo "$image_tag" | tr '[:upper:]' '[:lower:]')

            docker buildx build \
              $CACHE_OPTION \
              --tag "$image_tag" \
              --file "$dockerfile" \
              --cache-from type=gha,scope=$module_name \
              --cache-to type=gha,mode=max,scope=$module_name \
              --load \
              "$dir"
          done

      - name: Start Containers with Compose
        run: |
          find . -name "docker-compose.yml" -not -path "*/.*" | while read compose_file; do
            dir=$(dirname "$compose_file")
            (
              cd "$dir"
              docker compose up -d
            )
          done